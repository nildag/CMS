{% extends 'base.html' %}
{% load static %}

{% block content %}
<!DOCTYPE html>
<html lang="es">

<head>
    <link href="https://cdn.datatables.net/1.11.5/css/jquery.dataTables.min.css" rel="stylesheet">
    <link href="https://cdnjs.cloudflare.com/ajax/libs/bootstrap-datepicker/1.9.0/css/bootstrap-datepicker.min.css" rel="stylesheet">
</head>

<body>
    <div class="container mt-4">
        <h2>Tabla de contenidos</h2>

        <!-- Contenido de la tabla y filtros -->
        <div class="row">
            <!-- Contenido de la tabla -->
            <div class="col-md-9">
                <!-- Tabla de contenidos -->
                <table class="table dataTable" id="miTabla">
                    <!-- Encabezados de la tabla -->
                    <thead>
                        <tr>
                            <th>Titulo</th>
                            <th>Autor</th>
                            <th>Fecha de Publicación</th>
                            <th>Categoria</th>
                            <th>Tipo Contenido</th>
                            <th>Opciones</th>
                        </tr>
                    </thead>
                    <!-- Cuerpo de la tabla -->
                    <tbody id="tablaContenido">
                        {% for contenido in contenidos %}
                        <tr>
                            <td>{{ contenido.titulo }}</td>
                            <td>{{ contenido.autor.first_name }} {{ contenido.autor.last_name }}</td>
                            <td class="fechaPublicacion">{{ contenido.fecha_creacion|date:"Y-m-d" }}</td>
                            <td class="categoria">{{contenido.categoria.nombre}}</td>
                            <td> 
                                 {% if contenido.tipo_contenido %}
                                    {{ contenido.tipo_contenido.nombre }}
                                {% else %}
                                    Sin tipo
                                {% endif %}
                            </td>
                            <td>
                                <a href="{% url 'contenido:ver_contenido' contenido.id %}" class="btn btn-info btn-sm">Ver</a>
                            </td>
                        </tr>
                        {% endfor %}
                    </tbody>
                </table>
            </div>

            <!-- Filtros -->
            <div class="col-md-3">
                <!-- Filtro de fechas -->
                <div class="mb-3">
                    <label for="startDate" class="form-label">Fecha de inicio</label>
                    <input type="text" class="form-control" id="startDate" placeholder="Fecha de inicio">
                </div>
                <div class="mb-3">
                    <label for="endDate" class="form-label">Fecha de fin</label>
                    <input type="text" class="form-control" id="endDate" placeholder="Fecha de fin">
                </div>

                <!-- Filtro de categorías -->
                <div class="mb-3">
                    <label for="categoriaFiltro" class="form-label">Categoría</label>
                    <select class="form-select" id="categoriaFiltro">
                        <option value="">Todas las Categorías</option>
                        {% for categoria in categorias %}
                            {% if categoria.nombre != 'System' %}
                                <option value="{{ categoria.nombre }}">{{ categoria.nombre }}</option>
                            {% endif %}
                        {% endfor %}
                    </select>
                </div>
                <!-- Filtro de tipo de contenido -->
                <div class="mb-3">
                    <label for="tipoContenidoFiltro" class="form-label">Tipo de Contenido</label>
                    <select class="form-select" id="tipoContenidoFiltro">
                        <option value="">Todos los tipos de contenido</option>
                        {% for tipo_contenido in tipos_contenido %}
                            <option value="{{ tipo_contenido.nombre }}">{{ tipo_contenido.nombre }}</option>
                        {% endfor %}
                    </select>
                </div>

                <!-- Botón para limpiar filtros -->
                <button class="btn btn-secondary" id="limpiarFiltros">Limpiar Filtros</button>
            </div>
        </div>
    </div>


    <script src="https://ajax.googleapis.com/ajax/libs/jquery/3.6.4/jquery.min.js"></script>
    <script src="https://cdn.datatables.net/1.11.5/js/jquery.dataTables.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/bootstrap-datepicker/1.9.0/js/bootstrap-datepicker.min.js"></script>

    <!-- Scripts -->
    <script>
        $(document).ready(function () {
            // Inicializar la tabla con DataTables
            $('#miTabla').DataTable(
                {
                    language:{
                        search: "Buscar:",
                        lengthMenu: "Mostrar _MENU_ contenidos por página",
                        zeroRecords: "No se encontraron resultados",
                        info: "Mostrando página _PAGE_ de _PAGES_",
                        infoEmpty: "No hay registros disponibles",
                        infoFiltered: "(filtrado de _MAX_ registros totales)",
                        paginate: {
                            first: "Primero",
                            last: "Último",
                            next: "Siguiente",
                            previous: "Anterior"
                        }
                    },
                    ordering: true
                }
            );

            // Inicializar los datepickers
            $('#startDate').datepicker({
                autoclose: true,
                format: 'yyyy-mm-dd', // Formato de fecha deseado
                todayHighlight: true,
                endDate: new Date() // No permitir fechas futuras
            });

            $('#endDate').datepicker({
                autoclose: true,
                format: 'yyyy-mm-dd',
                todayHighlight: true,
                endDate: new Date() // No permitir fechas futuras
            });

            // Escuchar eventos de cambio en los campos de fecha y categoría
            $('#startDate #fechaFin, #categoriaFiltro, #tipoContenidoFiltro').change(function () {
                // Obtener valores de los campos
                var startDateString = $('#startDate').val();
                var endDateString = $('#endDate').val();
                var categoriaSeleccionada = $('#categoriaFiltro').val();
                var tipoContenidoSeleccionado = $('#tipoContenidoFiltro').val();

                // Filtrar las filas de la tabla por fechas,categoría y tipo de contenido
                $('#tablaContenido tr').each(function () {
                    var fechaPublicacionString = $(this).find('.fechaPublicacion').text();
                    var categoriaContenido = $(this).find('.categoria').text();
                    var tipoContenido = $(this).find('.tipoContenido').text();

                    // Verificar si el contenido cumple con los filtros
                    var cumpleFiltros = true;

                    // Filtrar por fechas
                    if (startDateString && endDateString) {
                        var fechaPublicacion = new Date(fechaPublicacionString);
                        var startDate = new Date(startDateString);
                        var endDate = new Date(endDateString);
                        if (fechaPublicacion < startDate || fechaPublicacion > endDate) {
                            cumpleFiltros = false;
                        }
                    }

                    // Filtrar por categoría
                    if (categoriaSeleccionada && categoriaContenido !== categoriaSeleccionada) {
                        cumpleFiltros = false;
                    }

                    // Filtrar por tipo de contenido
                    if (tipoContenidoSeleccionado && tipoContenido !== tipoContenidoSeleccionado) {
                        cumpleFiltros = false;
                    }

                    // Mostrar u ocultar la fila según los filtros
                    if (cumpleFiltros) {
                        $(this).show();
                    } else {
                        $(this).hide();
                    }
                });
            });

            // Escuchar el evento de clic en el botón de limpiar filtros
            $('#limpiarFiltros').click(function () {
                // Restablecer los valores de los campos de fecha y categoría
                $('#startDate').val('');
                $('#endDate').val('');
                $('#categoriaFiltro').val('');
                $('#tipoContenidoFiltro').val('');
                // Mostrar todas las filas en la tabla
                $('#tablaContenido tr').show();
            });
        });
    </script>
</body>

</html>

{% endblock %}
