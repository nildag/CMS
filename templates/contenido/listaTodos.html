{% extends 'base.html' %}
{% load static %}

{% block content %}
<!DOCTYPE html>
<html lang="es">

<head>
    <link href="https://cdnjs.cloudflare.com/ajax/libs/bootstrap-datepicker/1.9.0/css/bootstrap-datepicker.min.css"
        rel="stylesheet">
</head>

<body>

    <div class="container mt-4">
        <h2>Tabla de contenidos</h2>
        <br>
        <!-- Boton buscar para mostrar buscador -->
        <div class="col-md-3 d-flex justify-content-start align-items-center mb-3">
            <input type="text" class="form-control" id="busquedaIngresada"
                placeholder="Busque por título, autor o categoria">
        </div>
        <br>
            <!-- Botón para limpiar los filtros -->
            <div>
            <!-- Filtro por fechas con Bootstrap-datepicker -->
            <div class="input-group mb-3">
                <input type="text" class="form-control" id="startDate" placeholder="Fecha de inicio" autocomplete="off">
                <div class="input-group-append">
                    <span class="input-group-text"> hasta </span>
                </div>
                <input type="text" class="form-control" id="endDate" placeholder="Fecha de fin" autocomplete="off">
                <div class="input-group-append">
                    <button class="btn btn-primary" type="button" id="filterButton">Filtrar</button>
                </div>
            </div>
            <!-- Botón para limpiar los filtros -->
            <button class="btn btn-secondary" type="button" id="clearFiltersButton">Limpiar Filtros</button>
        </div>

        <!-- tablas de contenidos -->
        <table class="table" id="miTabla">
            <thead>
                <tr>
                    <th scope="col" data-columna="titulo">Titulo <i class='fas fa-sort'></i></th>
                    <th scope="col" data-columna="autor">Autor <i class='fas fa-sort'></i></th>
                    <th scope="col" data-columna="fecha">Fecha de Publicación <i class='fas fa-sort'></i></th>
                    <th scope="col" data-columna="categoria">Categoria <i class='fas fa-sort'></i></th>
                    <th scope="col">Acciones</th>
                </tr>
            </thead>
            <tbody id="tablaContenido">
                {% for contenido in contenidos %}
                <tr>
                    <td>{{ contenido.titulo }}</td>
                    <td>{{ contenido.autor.first_name }} {{ contenido.autor.last_name }}</td>
                    <td class="fechaPublicacion">{{ contenido.fecha_creacion|date:"Y-m-d" }}</td>
                    <td>{{ contenido.categoria.nombre }}</td>
                    <td>
                        <a href="{% url 'contenido:ver_contenido' contenido.id %}"
                            class="btn btn-info btn-sm">Ver</a>
                    </td>
                </tr>
                {% endfor %}
            </tbody>
        </table>

    </div>

    <script src='https://kit.fontawesome.com/a076d05399.js' crossorigin='anonymous'></script>
    <script src="https://ajax.googleapis.com/ajax/libs/jquery/3.6.4/jquery.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/bootstrap-datepicker/1.9.0/js/bootstrap-datepicker.min.js"></script>
    <script>
        $(document).ready(function () {
            // Inicializar los datepickers
            $('#startDate').datepicker({
                autoclose: true,
                format: 'yyyy-mm-dd', // Formato de fecha deseado
                todayHighlight: true,
                endDate: new Date() // No permitir fechas futuras
            });

            $('#endDate').datepicker({
                autoclose: true,
                format: 'yyyy-mm-dd',
                todayHighlight: true,
                endDate: new Date() // No permitir fechas futuras
            });

            // Filtro por término de búsqueda
            $('#busquedaIngresada').keyup(function () {
                var searchTerm = $(this).val().toLowerCase();

                // Filtrar las filas de la tabla por término de búsqueda
                $('#tablaContenido tr').each(function () {
                    var contenidoTexto = $(this).text().toLowerCase();
                    if (contenidoTexto.includes(searchTerm)) {
                        $(this).show();
                    } else {
                        $(this).hide();
                    }
                });
            });

            // Script para filtrar la tabla de contenidos por fechas
            $('#filterButton').click(function () {
                var startDateString = $('#startDate').val();
                var endDateString = $('#endDate').val();

                // Validar las fechas
                if (startDateString === '' || endDateString === '') {
                    alert('Por favor, selecciona ambas fechas.');
                    return;
                }

                // Convertir las fechas a objetos Date
                var startDate = new Date(startDateString);
                var endDate = new Date(endDateString);

                // Filtrar las filas de la tabla por las fechas seleccionadas
                $('#tablaContenido tr').hide();
                $('#tablaContenido tr').each(function () {
                    // Obtener la fecha de publicación de la fila y convertirla a objeto Date
                    var fechaPublicacionString = $(this).find('.fechaPublicacion').text();
                    var fechaPublicacion = new Date(fechaPublicacionString);

                    // Comparar las fechas y mostrar las filas que cumplen con el filtro de fecha
                    if (fechaPublicacion >= startDate && fechaPublicacion <= endDate) {
                        // Obtener el término de búsqueda y convertirlo a minúsculas
                        var terminoBusqueda = $('#busquedaIngresada').val().toLowerCase();
                        // Obtener el texto de la fila y convertirlo a minúsculas
                        var contenidoTexto = $(this).text().toLowerCase();

                        // Comparar el texto de la fila con el término de búsqueda y mostrar las filas que coinciden
                        if (contenidoTexto.includes(terminoBusqueda)) {
                            $(this).show();
                        }
                    }
                });
            });
        });

            // Botón para limpiar los filtros
             $('#clearFiltersButton').click(function () {
            // Restablecer el valor del campo de búsqueda y mostrar todas las filas
            $('#busquedaIngresada').val('');
            $('#tablaContenido tr').show();

            // Restablecer los valores de los datepickers
            $('#startDate').datepicker('setDate', null);
            $('#endDate').datepicker('setDate', null);
        });
    </script>

</body>
</html>

{% endblock %}
